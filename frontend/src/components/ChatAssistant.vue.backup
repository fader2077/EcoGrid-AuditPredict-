<template>
  <div class="bg-white rounded-lg shadow-sm p-6">
    <h2 class="text-xl font-bold mb-4">ğŸ’¬ Chat Assistant</h2>
    
    <!-- Messages -->
    <div class="border rounded-lg p-4 h-96 overflow-y-auto mb-4 bg-gray-50">
      <div
        v-for="(msg, index) in messages"
        :key="index"
        class="mb-4"
        :class="msg.role === 'user' ? 'text-right' : 'text-left'"
      >
        <div
          class="inline-block px-4 py-2 rounded-lg max-w-[80%]"
          :class="msg.role === 'user' 
            ? 'bg-primary-500 text-white' 
            : 'bg-white border border-gray-200'"
        >
          <p class="text-sm whitespace-pre-wrap">{{ msg.content }}</p>
          <span class="text-xs opacity-70">{{ msg.timestamp }}</span>
        </div>
      </div>
      
      <div v-if="loading" class="text-center">
        <span class="inline-block animate-pulse text-gray-500">AI æ€è€ƒä¸­...</span>
      </div>
    </div>
    
    <!-- Input -->
    <div class="flex gap-2">
      <input
        v-model="input"
        @keyup.enter="sendMessage"
        type="text"
        placeholder="è¼¸å…¥å•é¡Œï¼Œä¾‹å¦‚ï¼šç‚ºä»€éº¼ä»Šå¤©ä¸‹åˆé›»è²»é€™éº¼é«˜ï¼Ÿ"
        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
        :disabled="loading"
      />
      <button
        @click="sendMessage"
        :disabled="loading || !input.trim()"
        class="px-6 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        ç™¼é€
      </button>
    </div>
  </div>
</template>

<script setup>
import { ref } from 'vue'
import { auditApi } from '../api/endpoints'

const messages = ref([
  {
    role: 'assistant',
    content: 'æ‚¨å¥½ï¼æˆ‘æ˜¯ EcoGrid AI åŠ©æ‰‹ï¼Œå¯ä»¥å¹«æ‚¨åˆ†æç”¨é›»æ•¸æ“šã€è§£ç­”å•é¡Œã€‚è«‹å•æœ‰ä»€éº¼å¯ä»¥å¹«åŠ©æ‚¨çš„ï¼Ÿ',
    timestamp: new Date().toLocaleTimeString()
  }
])

const input = ref('')
const loading = ref(false)

const sendMessage = async () => {
  if (!input.value.trim() || loading.value) return
  
  const userMessage = {
    role: 'user',
    content: input.value,
    timestamp: new Date().toLocaleTimeString()
  }
  
  messages.value.push(userMessage)
  
  const question = input.value
  input.value = ''
  loading.value = true
  
  try {
    const response = await auditApi.query(question)
    
    messages.value.push({
      role: 'assistant',
      content: response.answer || 'æŠ±æ­‰ï¼Œç„¡æ³•å›ç­”æ­¤å•é¡Œã€‚',
      timestamp: new Date().toLocaleTimeString()
    })
  } catch (error) {
    messages.value.push({
      role: 'assistant',
      content: 'æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message,
      timestamp: new Date().toLocaleTimeString()
    })
  } finally {
    loading.value = false
  }
}
</script>
