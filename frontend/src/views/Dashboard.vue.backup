<template>
  <div class="space-y-6">
    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">ç•¶å‰è² è¼‰</p>
            <p class="text-2xl font-bold text-gray-900">
              {{ summary?.current_load_kw?.toFixed(1) || '0.0' }} <span class="text-sm">kW</span>
            </p>
          </div>
          <div class="text-4xl">âš¡</div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">ç¶ é›»æ¯”ä¾‹</p>
            <p class="text-2xl font-bold text-primary-600">
              {{ summary?.renewable_ratio?.toFixed(1) || '0.0' }} <span class="text-sm">%</span>
            </p>
          </div>
          <div class="text-4xl">ğŸŒ¿</div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">ä»Šæ—¥æˆæœ¬</p>
            <p class="text-2xl font-bold text-gray-900">
              {{ (summary?.estimated_cost_today || 0).toLocaleString() }} <span class="text-sm">NTD</span>
            </p>
          </div>
          <div class="text-4xl">ğŸ’°</div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">é›»æ± ç‹€æ…‹</p>
            <p class="text-2xl font-bold text-secondary-600">
              {{ ((summary?.battery_soc || 0) * 100).toFixed(0) }} <span class="text-sm">%</span>
            </p>
          </div>
          <div class="text-4xl">ğŸ”‹</div>
        </div>
      </div>
    </div>
    
    <!-- TOU Period -->
    <div class="bg-white rounded-lg shadow-sm p-4">
      <div class="flex items-center justify-between">
        <div>
          <span class="text-sm text-gray-600">ç›®å‰é›»åƒ¹æ™‚æ®µï¼š</span>
          <span class="ml-2 px-3 py-1 rounded-full text-sm font-medium"
                :class="touPeriodClass">
            {{ touPeriodText }}
          </span>
        </div>
        <div class="text-lg font-bold">
          {{ summary?.current_tariff?.toFixed(2) || '0.00' }} NTD/kWh
        </div>
      </div>
    </div>
    
    <!-- Chart -->
    <div class="bg-white rounded-lg shadow-sm p-6">
      <EnergyChart
        v-if="chartData.timestamps.length > 0"
        :data="chartData"
        title="24å°æ™‚ç”¨é›»è¶¨å‹¢"
        height="400px"
      />
      <div v-else class="text-center py-12 text-gray-500">
        æš«ç„¡åœ–è¡¨æ•¸æ“š
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useDashboardStore } from '../stores/dashboard'
import { dashboardApi } from '../api/endpoints'
import EnergyChart from '../components/EnergyChart.vue'

const dashboardStore = useDashboardStore()
const summary = computed(() => dashboardStore.summary)

const chartData = ref({
  timestamps: [],
  series: {}
})

const touPeriodText = computed(() => {
  const period = summary.value?.tou_period
  if (period === 'peak') return 'å°–å³°'
  if (period === 'half_peak') return 'åŠå°–å³°'
  return 'é›¢å³°'
})

const touPeriodClass = computed(() => {
  const period = summary.value?.tou_period
  if (period === 'peak') return 'bg-red-100 text-red-700'
  if (period === 'half_peak') return 'bg-yellow-100 text-yellow-700'
  return 'bg-green-100 text-green-700'
})

const fetchData = async () => {
  await dashboardStore.fetchSummary()
  
  // Fetch chart data (last 24 hours)
  const endDate = new Date()
  const startDate = new Date(endDate.getTime() - 24 * 60 * 60 * 1000)
  
  try {
    const data = await dashboardApi.getChartData({
      start_date: startDate.toISOString(),
      end_date: endDate.toISOString(),
      data_type: 'load'
    })
    chartData.value = data
  } catch (error) {
    console.error('Failed to fetch chart data:', error)
  }
}

onMounted(() => {
  fetchData()
  // Auto-refresh every 30 seconds
  setInterval(fetchData, 30000)
})
</script>
